Form Validation follows the HTML5 standards for [client-side form validation](https://developer.mozilla.org/en-US/docs/Learn/Forms/Form_validation). It overrides the built-in browser form validation with custom JavaScript functionality for a more accessible and consistent experience across browsers.

## Style

Form Validation does not contain any component-specific CSS styles. However, various utility classes and supporting components are used in combination to display error messaging and other elements appropriately.

### Utility classes

| Utility             | Example       | Description         | Documentation |
|---------------------|---------------|---------------------|---------------|
| Text color          | `text-muted`  | Sets text color     | [Text color utility docs](https://moray-prod.azurewebsites.net/components/detail/utilities-color--text-only.html) |
| Margin              | `ml-4`        | Sets margin         | [Margin utility docs](https://moray-prod.azurewebsites.net/components/detail/utilities-spacing--margin) |
| Screen reader only  | `sr-only`     | Makes content available only to screen reader users | [Screen reader utility docs](https://moray-prod.azurewebsites.net/components/detail/utilities-screenreaders--sr-only-focusable.html) |


### Supporting components

Properly constructed forms and form elements are required for validation to render and function properly. Aside from the various form-related components available in the Moray framework to construct a form, several supporting components are used specifically for validation messaging.

#### Forms

The class `.form-text` is used to style inline text hints. See [hint](#hint) behavior for more information.

```html
<p class="form-text text-muted" id="zip-hint">A valid five-digit US zip code.</p>
```

#### Alert

Alerts are used to style the [feedback list](#feedback-list) and display [server-side errors](#server-errors) to the user. A warning glyph is used within the Alert as a stylistic enhancement.

```html
<div class="alert mb-3" data-mount="feedback-list">
  <span class="glyph-prepend glyph-prepend-warning" aria-hidden="true"></span>
  <section aria-label="Error information" class="alert-content">
    ...
  </section>
</div>
```

#### Lists

An ordered list using the list modifier class `.list-unstyled` is used to display a list of errors within the [feedback list](#feedback-list).

```html
<ol class="list-unstyled"></ol>
```


## Behavior

To validate form fields, they must be wrapped inside a single `<form>` element. The property `novalidate` is added to disable browser default feedback tooltips.

```html
<form novalidate>
  ...
</form>
```

If the form contains required fields, those fields must be denoted with an asterisk. To clarify the meaning of the asterisk, a message should be placed at the beginning of the form element prior to any form fields. This message should not be read by screen readers, and therefore should have `aria-hidden="true"` applied.

```html
<form data-mount="validation" novalidate>
  <p class="text-muted" aria-hidden="true">* Please complete required fields to submit.</p>
  ...
```

### Fields

Required fields must have an asterisk preceding the label text. The asterisk must be wrapped in a `<span>` with the attribute `aria-hidden="true"`.

```html
<label for="zip"><span aria-hidden="true">*</span>Zip code</label>
```

The input should follow its associated label. 

```html
<input type="text" id="zip" required name="zip" aria-invalid="false">
```
- If the field is required, it must have the attribute `required`
- All inputs must have a `name` attribute in order for their value to be submitted with the form (see MDN article [\<input>: The Input (Form Input) element](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#attr-name) for more information)
- `aria-invalid="false"` *must* be added to any form field needing validation
- To validate formatting, use the `pattern` attribute with a regular expression (see MDN article [HTML attribute: pattern](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/pattern) for more information)
- A single required input should never be wrapped in a `<fieldset>` element

### Fieldsets

Radio buttons or groups of checkboxes that need to be validated as a group must be wrapped in the `<fieldset>` element. A `<legend>` must accompany the fieldset as its immediate child before any fields.

- The `<legend>` must have an `id` that is added to the `<fieldset>`'s `aria-labelledby` attribute as a token
- Required fieldsets must have an asterisk preceding the legend text; the asterisk must be wrapped in a `<span>` with the attribute `aria-hidden="true"`

```html
<fieldset class="form-group" aria-labelledby="like-legend">
  <legend id="like-legend"><span aria-hidden="true">*</span><span class="sr-only">Required</span> Do you like the Microsoft Store?</legend>
  ...
</fieldset>
```

#### Inputs

Each field's input within the fieldset must include an `aria-invalid="false"`.

```html
<div class="custom-control custom-radio">
  <input type="radio" class="custom-control-input" id="like-yes" name="like" value="yes" aria-invalid="false">
  <label class="custom-control-label" for="like-yes"><span class="custom-control-glyph" aria-hidden="true"></span>Yes</label>
</div>
```

Note that when input elements such as radio buttons and checkboxes are validated as a set, they *must not* use the `required` attribute. To validate these sets as required, the custom data attribute `data-form-check-required` must be applied to the ***first*** input of the set only. Inputs within a fieldset, should have the same `name` attribute.

```html
<div class="custom-control custom-radio">
  <input type="radio" class="custom-control-input" id="like-yes" name="like" value="yes" aria-invalid="false" data-form-check-required>
  <label class="custom-control-label" for="like-yes"><span class="custom-control-glyph" aria-hidden="true"></span>Yes</label>
</div>
<div class="custom-control custom-radio">
  <input type="radio" class="custom-control-input" id="like-no" name="like" value="no" aria-invalid="false">
  <label class="custom-control-label" for="like-yes"><span class="custom-control-glyph" aria-hidden="true"></span>Yes</label>
</div>
```

When validating checkbox sets, you may set a minimum and a maximum required number to be checked. Define the minimum number with `data-form-check-required` and the maximum number with `data-form-check-max` on the ***first*** input of the set only.

```html
<div class="custom-control custom-checkbox">
  <input type="checkbox" class="custom-control-input" id="hear-search" name="hear" value="search" data-form-check-required="1" data-form-check-max="3" aria-invalid="true">
  <label class="custom-control-label" for="hear-search"><span class="custom-control-glyph" aria-hidden="true"></span>Search engine</label>
</div>
```

> Any additional Form Validation data attributes that would normally be added to an input field should be applied to the first input only for radio buttons or grouped checkboxes within a fieldset.

### Field help

There are three optional elements that could appear after an individual field or group of fields (e.g., within a fieldset). If enabled, they should appear in the following order:

1. Hint
2. Character count
3. Invalid feedback

#### Hint

A hint provides additional context on what is expected within its associated form field or fieldset.

For individual fields, the `id` of the hint element must be supplied to an `aria-describedby` attribute on the form control element (`<input>`, `<select>`, `<textarea>`, etc) for the hint to be read by screen readers.

```html
<input type="text" id="zip" aria-describedby="zip-hint">
<p class="form-text text-muted" id="zip-hint">A valid five-digit US zip code.</p>
```

For fieldsets, the `id` of the hint element must be supplied to the `aria-labelledby` attribute. This attribute may contain multiple `id`s in addition to the hint `id`.

```html
<fieldset class="form-group" aria-labelledby="hear-legend hear-hint">
  <legend id="hear-legend">How did you hear about us?</legend>
  ...
</fieldset>
<p class="form-text text-muted" id="hear-hint">Select up to 3</p>
```

#### Character count

Refer to documentation found under the [Character Count](https://moray-prod.azurewebsites.net/components/detail/character-count--input.html) component.

#### Feedback

Feedback is an inline validation message. This message will be triggered by user interaction. Feedback should clearly communicate the issue and field that the message is associated with; it should inform the user about how to resolve the issue.

For individual fields, the following attributes must be applied to the form control (`<input>`, `<select>`, `<textarea>`, etc) and feedback elements:

```html
<input type="text" id="zip" required aria-invalid="false" aria-describedby="zip-feedback" data-feedback="zip-feedback" data-feedback-content="You must enter a valid US zip code.">
<div class="invalid-feedback" id="zip-feedback"></div>
```

| Element             | Attribute               | Value               | Description                     |
|---------------------|-------------------------|---------------------|---------------------------------|
| input               | `aria-describedby`      | `id` of feedback; may contain other `id`s | Connects the feedback element with the appropriate form element for assistive technology |
| input               | `data-feedback`         | `id` of feedback    | Identifies the element to populate the `data-feedback-content` value with if the form element is invalid |
| input               | `data-feedback-content` | `String`            | Message that clearly communicates the issue and field with which the error is associated |
| feedback            | `id`                    | a unique identifier | Token for the associated input's `aria-describedby` attribute |

For groups of fields, the following attributes must be applied to the fieldset and feedback elements:

```html
<fieldset class="form-group" aria-labelledby="hear-legend hear-hint hear-feedback">
  <legend id="hear-legend">How did you hear about us?</legend>
    ...
    <!-- First input of set -->
    <input type="checkbox" id="hear-check-01" name="hear" value="search" data-feedback-content="Between one and three ways you've heard about us must be selected." data-feedback="hear-feedback" data-form-check-required="1" data-form-check-max="3">
    ...
  <div class="invalid-feedback" id="hear-feedback"></div>
</fieldset>
<p class="form-text text-muted" id="hear-hint">Select up to 3</p>
```

| Element             | Attribute               | Value               | Description                     |
|---------------------|-------------------------|---------------------|---------------------------------|
| fieldset            | `aria-labelledby`       | `id` of feedback; may contain other `id`s | Connects the feedback element with the appropriate fieldset for assistive technology |
| input*              | `data-feedback`         | `id` of feedback    | Identifies the element to populate the `data-feedback-content` value with if the form element is invalid |
| input*              | `data-feedback-content` | `String`            | Message that clearly communicates the issue and field with which the error is associated |
| feedback            | `id`                    | a unique identifier | Token for the associated input's `aria-labelledby` attribute |

*When adding feedback messaging to a fieldset of radio buttons or grouped checkboxes, the attribute must only be applied to the ***first*** input of the set.

### Feedback list

A `<div>` element with the attribute `data-mount="feedback-list"` should be placed at the bottom of the form before the "submit" button. This container must have an ***empty*** ordered list as a descendent. This `<ol>` will be auto-populated with items that link to invalid form fields as they are validated.

```html
<div data-mount="feedback-list">
  ...
  <ol></ol>
  ...
</div>
```

Additionally, the ordered list should be wrapped in a `<section>` element within the container with the attribute `aria-label="Error information"` to provide additional information to users of assistive technologies. Instructional text should be provided for all users in a heading element appropriate to the content structure. The ordered list must be preceded by the instructional text as an immediate sibling in the DOM.

```html
<div data-mount="feedback-list">
  <section aria-label="Error information">
    <h3>Please resolve the following errors before submission</h3>
    <ol></ol>
  </section>
</div>
```

### Server errors

Although Moray's form validation does *not* cover server-side validation scenarios, the following guidance should be considered when displaying server-side errors to users.

Server-side errors should be rendered within a [dismissible Alert](https://mwf.azurewebsites.net/catalog/alert/index.html#dismissible) with a "warning" glyph.

If submitting the form does *not* trigger a page refresh:
1. Place the Alert at the bottom of the form before the "submit" button.
2. Set programmatic focus to the error message once it appears.

If submitting the form does trigger a page refresh:
1. Place an Alert at the top of the form.
2. Wait for page to load.
3. Set a timeout of at least 700ms.
4. When timeout fires insert the error message into the element with `role="alert"`.
  - Note: An element with the Alert attribute must be present on page load with no content inside
  - Add a "Go to submit" link to the end of the error message if the user's only action is to resubmit the form

## JavaScript usage

### Initialization

Adding `data-mount="validation"` to the `<form>` element will auto-initialize validation on page load. Options can be set using additional data attributes on the HTML. If more control and customization is needed, it may be necessary to initialize your component manually by directly calling the JavaScript constructor.

| Element     | Attribute                       | Value                 | Instance member          | Required | Description                     |
|-------------|---------------------------------|-----------------------|--------------------------|----------|---------------------------------|
| form        | `data-mount`                    | `"validation"`        | `el`                     | yes*     | Initializes validation for the form |
| form        | `data-prevent-form-submission`  | `"true"` \| `"false"` | `preventFormSubmission`  | no       | Prevent the form from submitting after successful validation, useful in AJAX scenarios, for example; Takes precedence over `allowEmptySubmit` |
| form        | `data-allow-empty-submit`       | `"true"` \| `"false"` | `allowEmptySubmit`       | no       | Allow the form to submit when all fields are empty |

\* **Attribute is required if using the auto-initialization method only. `data-` attributes are not recommended for use otherwise and may result in unexpected behavior.**

To initialize Form Validation directly, create a new instance by passing in the reference of the form element using the `el` option.

```js
validationInstance = new mwf.FormValidation({
  el: document.querySelector('#formId')
});
```

| Property                | Type          | Required | Default  | Description                          |
|-------------------------|---------------|----------|----------|--------------------------------------|
| `el`                    | `HTMLElement` | yes      | `null`   | The form element that requires validation |
| `preventFormSubmission` | `Boolean`     | no       | `false`  | Flag to prevent form submission; Takes precedence over `allowEmptySubmit` |
| `allowEmptySubmit`      | `Boolean`     | no       | `false`  | Flag to allow the form to submit when all fields are empty |
| `feedbackListContainer` | `HTMLElement` | yes      | `null`   | The container for the feedback list  |

### Events
| Name        | Target          | Description                                    |
|-------------|-----------------|------------------------------------------------|
| `onRemove`  | _instance_.`el` | Dispatches when validation is removed          |
| `onValid`   | _instance_.`el` | Dispatches when a child form element is valid  |
| `onUpdate`  | _instance_.`el` | Dispatches when instance is updated            | 

### Static methods

#### getInstances()
Returns a list of all validation instances.

| Returns | Description                                           |
|---------|-------------------------------------------------------|
| `Array` | An array of all current instantiated validation       |

### Instance methods

#### validate()
Validate form input.

| Params  | Type          | Required | Default  | Description                 |
|---------|---------------|----------|----------|-----------------------------|
| `input` | `HTMLElement` | yes      | `null`   | The form input to validate  |

#### isInputValid()
Check if given input is valid.

| Params  | Type          | Required | Default  | Description                 |
|---------|---------------|----------|----------|-----------------------------|
| `input` | `HTMLElement` | yes      | `null`   | The form input to validate  |

| Returns   | Description                        |
|-----------|------------------------------------|
| `Boolean` | Whether or not the input is valid  |

#### isFormValid()
Check if all inputs in the form are valid.

| Returns   | Description                       |
|-----------|-----------------------------------|
| `Boolean` | Whether or not the form is valid  |

#### update()

Updates instance without removing it. Optionally changes `preventFormSubmission` and `allowEmptySubmit` flags as well as `feedbackListContainer` element.

| Name                         | Type       | Required | Default | Description |
|------------------------------|------------|----------|---------|-------------|
| `opts`                       | `Object`   | no       | `{}`    | An object containing configuration options. |
| `opts.preventFormSubmission` | `Boolean`  | no       | null    | Flag to prevent form submission |
| `opts.allowEmptySubmit`      | `Boolean`  | no       | null    | Flag that determines whether to allow empty forms to submit |
| `opts.feedbackListContainer` | `Node`     | no       | null    | The feedback list container DOM node |

The option(s) need to be passed in as a config object like so:  

```js
validationInstance.update({
  preventFormSubmission: true,
  allowEmptySubmit: false,
  feedbackListContainer: myContainer
});
```

#### remove()
Removes all event listeners, observers, and references to the validation instance.

### Instance properties

| Name | Type | Description |
|------|------|-------------|
| `allowEmptySubmit`      | `Boolean`     | Flag to allow the form to submit when all fields are empty |
| `el`                    | `HTMLElement` | The form element that requires validation |
| `events`                | `Array`       | An array of objects describing the event listeners and handlers added by this instance |
| `feedbackList`          | `HTMLElement` | The unordered list that gets dynamically populated with validation errors |
| `feedbackListContainer` | `HTMLElement` | The container for the feedback list |
| `feedbackListFocusEl`   | `HTMLElement` | The first element to receive focus in the feedback list |
| `inputs`                | `NodeList`    | A list of all form inputs contained within the validating form |
| `onUpdate`              | `CustomEvent` | The custom event that is fired when the instance is updated via the `.update()` instance method |
| `onRemove`              | `CustomEvent` | The custom event that is fired when the instance is removed via the `.remove()` instance method |
| `onValid`               | `CustomEvent` | The custom event that fires if the form is valid after calling the `.validate()` instance method |
| `preventFormSubmission` | `Boolean`     | Flag to prevent form submission; Takes precedence over `allowEmptySubmit` |
| `submit`                | `HTMLElement` | The form element's submit button |