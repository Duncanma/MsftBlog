A Popover is a small flyout dialog launched by a triggering button. Unlike the Modal, it does not take over the page preventing interaction with the contents below. The Popover dialog appears next to the triggering button with a triangular "speech bubble" indicator arrow pointing to the button.

## Responsiveness

The maximum width of the Popover is fixed at `336px` for all viewports. This width does not include the indicator arrow. It can be smaller if the text is short enough, but be advised that when the Popover is initialized, a minimum width based on the initial content is set as an inline style. So, if the text starts long and becomes short, it may leave empty space in the Popover dialog.

The Popover is positioned next to its button in one of four directions (`left`, `right`, `top`, or `bottom`) based on the `placement` option chosen during initialization. When shown, if the viewport is constrained so that the Popover will not fit next to its button on its preferred side, it will try alternatives according to this table:

| Preferred placement | 1st alternative | 2nd alternative | 3rd alternative |
|---------------------|-----------------|-----------------|-----------------|
| `left`              | `bottom`        | `top`           | `right`         |
| `right`             | `bottom`        | `top`           | `left`          |
| `top`               | `right`         | `bottom`        | `left`          |
| `bottom`            | `right`         | `top`           | `left`          |

If there isn't room on any side, it will fall back to a `bottom` placement. However, note that it will not reposition itself automatically if it is open when the viewport changes. It must either be hidden and shown again, or the `positionMenu` method must be called on the relevant instance of the Popover class, e.g.

```js
myPopover.positionMenu();
```

## Style

The Popover dialog overlays the main content of the page but not its triggering button. Unlike the [Modal](https://moray-prod.azurewebsites.net/components/detail/modal--default.html), it does not visually obscure the rest of the content, which remains interactive for mouse and touchscreen users. In extremely restricted viewports, a Popover may overflow the document, causing the browser to show scrollbars. While the Popover dialog is shown, the triggering button gets a distinctive "active" style that inverts its colors to visually indicate that it is active.

The background color of the Popover is set to the `body` color of the current [Theme](https://moray-prod.azurewebsites.net/components/detail/theme--dark.html), typically `#000` or `#fff`. Headings with the recommended `popover-heading` class will appear visually a normal-sized bold text, and all text within the Popover will have the style `overflow-wrap: break-word`, so that particularly long words will not overflow the Popover.

The indicator arrow pointing back at the triggering button is actually an empty square `<div>` rotated 45 degrees. Its background color is the same as the border color of the Popover, with a slightly smaller `::after` pseudo-element the same color as the Popover background layered on top. Note that this means that customizations to the Popover's border color will not be inherited but will instead have be set as a _background_ color on the arrow element itself. For example, using the [Border](https://moray-prod.azurewebsites.net/components/detail/utilities-borders--color.html) and [Background Color](https://moray-prod.azurewebsites.net/components/detail/utilities-color--colors.html) utilities:

```html
<div class="popover border-green" role="dialog">
  (Popover content)
  <div class="arrow bg-green"></div>
</div>
```

Note that for similar reasons, customizations to the background color of the Popover will not be inherited by the indicator arrow, and must be set via stylesheet rule targeting the `::after` pseudo-element.

If the class `fade` is used on the Popover dialog, it will fade in and out as it is shown and hidden, respectively. Note that the `fade` class is optional, and not required to show and hide the Popover.

```html
<div class="popover fade" role="dialog">
  (Popover content)
</div>
```

### Supporting components

Popovers are dialogs that receive and trap focus. For the users of some assistive technologies such as screen readers, this can be disruptive and disorienting if the Popover was not launched by the user intentionally. For this reason, Popovers must always be tied to a triggering button and only launched when that button is pressed by the user. For Popovers, the triggering button must _semantically_ be a button, meaning that it is either a `<button>` element or an element with the attribute `role="button"` on it. Note that this is distinct from the [Button](https://moray-prod.azurewebsites.net/components/detail/button--default.html) component, which includes links styled to look like buttons.

Popovers should not be triggered by disabled elements, nor should the disabled element appear to trigger the Popover by other means. In such situations, it is recommended to place another visually distinguishable button or trigger next to the disabled element you wish to use a Popover dialog with. For example, an "info" icon that triggers a Popover next to a disabled button.

Every Popover dialog should include a [Close](https://moray-prod.azurewebsites.net/components/detail/close.html) button component. Even though clicking outside the Popover dialog and pressing the ESC key both close the dialog, the Close button is a vital affordance for keyboard and assistive technology users.

## Behavior

The Popover consists of two pieces of content: the triggering button and the Popover dialog. For the Popover class, the triggering button is considered the "base" element, accessible at _instance_.`el` and indispensable to its function; it must exist before the Popover class is instantiated and initialized. By contrast, the Popover dialog may be supplied either as an existing element pointed to by the triggering button, or created by the Popover instance based on text supplied via the `data-content` attribute.

### Supplied dialog

One approach is to supply a dialog that already exists (it _must_ exist in the DOM when the instance is initialized) and point to it with the `aria-controls` attribute. It may also be supplied to the Popover constructor as `Node` object, but `aria-controls` must point to it anyways for accessibility reasons. Note that this option takes precedence, so if the triggering button has the `aria-controls` attribute, even if it is undefined, it will not attempt to generate a Popover dialog. To properly supply a Popover dialog, ensure that the following template is followed:

```html
<!-- Triggering button -->
<button id="popover01" 
  aria-expanded="false" 
  aria-controls="popover01_dialog"
>
  (Descriptive button text)
</button>
<!-- Popover dialog -->
<div  class="popover" 
  id="popover01_dialog" 
  role="dialog"
  aria-labelledby="popover01"
>
  <button class="close" aria-label="Close dialog"></button>
  <div class="popover-content">
    <div class="popover-body">
      (Popover dialog content)
    </div>
  </div>
</div>
```

In order for the Popover to initialize properly, the following properties must be set in the DOM:

| Element           | Property              | Value                       | Description                                                                             |
|-------------------|-----------------------|-----------------------------|-----------------------------------------------------------------------------------------|
| Triggering button | `id`                  | A unique ID                 | Lets the Popover dialog point at the triggering button                                  |
| Triggering button | `aria-expanded`       | `false`                     | Indicates whether the Popover dialog is shown; should be false initially                |
| Triggering button | `aria-controls`       | `id` of the dialog          | Indicates that it controls the dialog and lets the Popover instance find it             |
| Popover dialog    | `id`                  | A unique ID                 | Lets the triggering button point at the Popover dialog                                  |
| Popover dialog    | `role`                | `dialog`                    | Indicates that it is a dialog; key for assistive technology                             |
| Popover dialog    | `aria-labelledby`     | `id` of trigger or heading  | Points to an element that describes the Popover dialog                                  |


Note that in the example the triggering button serves as the label for the Popover dialog, but this can also be done with a heading:

```html
<div  class="popover" 
  id="popover01_dialog" 
  role="dialog"
  aria-labelledby="popover01_heading"
>
  <button class="close" aria-label="Close dialog"></button>
  <div class="popover-content">
    <h2 class="popover-header" id="popover01_heading">(Descriptive heading text)</h2>
    <div class="popover-body">
      (Popover dialog content)
    </div>
  </div>
</div>
```

The Close button is required for accessibility, while the rest of the structure and classes within the Popover dialog is strongly recommended to ensure that styles are as designed.

### Generated dialog

The Popover dialog can also be generated during the initialization of the Popover instance. It will generate all necessary markup and properties discussed in the previous section based on text supplied in the `data-content` attribute of the triggering button:

```html
<button id="popover01" 
  data-content="(Popover dialog content)"
  data-close-label="Close dialog"
>
  (Descriptive button text)
</button>
```

Note that there are some restrictions with this approach. Only plain text may be supplied and no heading may be specified; the dialog will be labeled by the triggering button. The triggering button must already have an `id` defined, but other necessary properties will be generated. The accessible label for the Close button may also be supplied, but will default to `"Close dialog"` if none is supplied.

### Showing the Popover dialog

When the triggering button is pressed, the Popover instance starts this launch sequence:

1. The state variable _instance_.`shown` is update to `true`
2. The triggering button gets the `active` class which visually indicates that it is pressed
3. The Popover dialog is shown, or starts to fade in, if the `fade` class is present
4. The Popover dialog is positioned
5. The Popover dialog Close button receives focus
6. Keyboard focus cannot leave the Popover dialog until it is closed; the dialog may be closed by clicking or tapping outside the dialog, or by pressing the ESC key or the Close button
7. A `CustomEvent` indicating that the Popover dialog has been shown is fired

### Hiding the Popover dialog

The Popover dialog may be closed or hidden in a number of ways. The Close button may be pressed, the ESC key may be pressed, or the user may click or tap anywhere outside the Popover dialog. Note than unlike [Modal](https://moray-prod.azurewebsites.net/components/detail/modal--default.html), when the user clicks or taps outside the Popover dialog, the click event is not intercepted, so the element that is clicked will receive focus. Whatever the case may be, the Popover instance starts this shut down sequence:

1. The state variable _instance_.`shown` is update to `true`
2. The triggering button loses the `active` class which visually indicates that it is pressed
3. The Popover dialog is hidden, or starts to fade out, if the `fade` class is present
4. If closed due to a click outside the dialog, the clicked element is focused, otherwise the Popover's triggering element is focused
5. Keyboard interactions return to normal
6. A `CustomEvent` indicating that the Popover dialog has been shown is fired


### Circular focus

When the Popover dialog is shown, focus cannot leave until it is closed known as a "keyboard trap." As the user is tabbing through the Popover dialog using the Tab key, if the focus moves outside the dialog, the focus will be intercepted and moved to either the first or last element (depending on the direction the user is tabbing) within the dialog that can receive tab focus.

An array of all tab focusable elements within a Popover's dialog is defined under its instance property `tabbableElements` on initialization. This list is used to determine the first and last focusable elements in the dialog. If the DOM within the dialog changes after initialization, this array can be refreshed by calling the `update()` method on the Popover instance. Popover uses the MWF Moray utility `Util.getTabbableElements`, passing it the Popover instance's `menu` element, to get the array.

### Positioning

When the Popover is shown, or when the `positionMenu` method is called, the Popover dialog is positioned next to the triggering button according to three settings, `placement`, `alignment`, and `offset`, each of which is readable as a property on the Popover class instance.

The `placement` property can be set to `left`, `right`, `top`, or `bottom`. This determines whether the Popover dialog should be placed left of, right of, above, or below the triggering button, respectively. When shown, if the viewport is constrained so that the Popover will not fit next to its button on its preferred side, it will try alternatives according to this table:

| Preferred placement | 1st alternative | 2nd alternative | 3rd alternative |
|---------------------|-----------------|-----------------|-----------------|
| `left`              | `bottom`        | `top`           | `right`         |
| `right`             | `bottom`        | `top`           | `left`          |
| `top`               | `right`         | `bottom`        | `left`          |
| `bottom`            | `right`         | `top`           | `left`          |

If there isn't room on any side, it will fall back to`bottom` regardless of the initial `placement` setting.

The `alignment` property can be set to `start`, `center`, or `end`. This determines how to align the Popover dialog with the triggering element. For horizontal placements (`left` and `right`), `start` aligns the top edges of the triggering button and Popover dialog, `end` aligns their bottom edges, and `center` aligns their centers. For vertical placements (`top` and `bottom`), `start` aligns the left edges of the triggering button and Popover dialog, `end` aligns their right edges, and `center` aligns their centers (in RTL pages `start` corresponds to right edges instead). If there isn't room on one side, the Popover will try the other side.

The `offset` property corresponds sets how many `pixels` of space to leave between the Popover dialog and the triggering button, _not including the indicator arrow_. For this reason it is not recommended to use a value below the default of `16` so that there's room for the indicator arrow.

## JavaScript usage

### Initialization

Adding `data-mount="popover"` to the triggering button will cause the MWF auto-initialization script to create an instance of Popover for it.

To initialize a Popover via JavaScript, create a new instance by passing in the reference of the Popover's triggering element using the `el` option, along with any other options.

```js
myPopover = new mwf.Popover({
  el: document.querySelector('#popoverId')
});
```

#### Options

These options may be passed to the Popover constructor. For some options, if it is not included, the constructor will examine a corresponding `data-` or `aria-` attribute before falling back to the default value.

| Name            | Type      | Required  | Default   | Alternate input                                             | Description                                                                       |
|-----------------|-----------|-----------|-----------|-------------------------------------------------------------|-----------------------------------------------------------------------------------|
| `el`            | `Node`    | yes       | `null`    | Add `data-mount="popover"` for auto-initialization          | The triggering button                                                             |
| `menu`          | `Node`    | no        | `null`    | Indicate with `aria-controls` or create with `data-content` | The Popover dialog                                                                |
| `placement`     | `String`  | no        | `right`*  | `data-placement`                                            | Sets preferred placement ( `left`, `right`, `top`, `bottom`, `start`, or `end`)   |
| `alignment`     | `String`  | no        | `center`  | `data-alignment`                                            | Sets preferred alignment (`start`, `center`, or `end`)                            |
| `offset`        | `Number`  | no        | `16`      | (None)                                                      | Sets the offset in pixels of the dialog from the trigger                          |
| `enableReflow`  | `Boolean` | no        | `true`    | `data-disable-reflow`                                       | Enables the dialog to re-position itself based on available space in the viewport |
| `enableFade`    | `Boolean` | no        | `true`    | Presence of `fade` class on the `menu` Node                 | Enables a fade in/out animation of the dialog                                     |

> *For placement, `left` and `right` options are LTR biased and will invert in RTL mode. Use `start` and `end` in place of `right` and `left` if code is specific to an RTL-first site to improve code clarity. Defaults to `right` in LTR, `left` in RTL. 

### Events

All of these event bubble, so they do not have to be listened for on the event target itself.

| Event name   | Event target    | Description                                        |
|--------------|-----------------|----------------------------------------------------|
| `onHide`     | _instance_.`el` | Dispatches when the dialog becomes hidden          |
| `onRemove`   | _instance_.`el` | Dispatches when the Popover instance is removed    |
| `onShow`     | _instance_.`el` | Dispatches when the dialog becomes shown           |
| `onUpdate`   | _instance_.`el` | Dispatches when the Popover instance is updated    |

### Static Methods

#### getInstances()

Returns a list of all Popover instances.

| Returns | Description                                     |
|---------|-------------------------------------------------|
| `Array` | An array of all currently instantiated Popovers |

### Getters

#### currentPosition

Returns the current calculated reflow position of the dialog (if `enableReflow` is not `false`) or the original placement and alignment.

| Returns  | Description |
|----------|-------------|
| Object   | An object containing the current calculated placement and an alignment values |

### Instance Methods

#### get currentPosition

This is a getter, so _instance_.`currentPosition` can be accessed like a property, but cannot be set that way. Calls a function whenever accessed.

Returns the current calculated reflow position of the dialog (if `enableReflow` is not `false`) or the original placement and alignment.

| Returns  | Description                                                                                                                |
|----------|----------------------------------------------------------------------------------------------------------------------------|
| `Object` | An object containing the current calculated placement and alignment values, e.g. `{alignment: "start", placement: "top"}`  |

#### calcReflowPosition()

Calculates the most appropriate position for the dialog according to the available space in the viewport and the original placement and alignment options supplied. This method saves the recorded reflow position object to the instance property `reflowPosition` for later use. Does not return a value.

#### hide()

Hides the Popover dialog and fires the `onHide` event.

| Parameters            | Type      | Default   | Description                                                                               |
|-----------------------|-----------|-----------|-------------------------------------------------------------------------------------------|
| _Options_             | `Object`  | `{}`      | An object containing options for hiding the Popover                                       |
| _Options_.`setFocus`  | `Boolean` | `true`    | Whether or not the focus should be set to the triggering element after hiding the dialog  |

Note that the options above are inherited from the Flyout class that is also extended by [Dropdown](https://moray-prod.azurewebsites.net/components/detail/dropdown--default.html). For Popover, this option should not be used; the focus should always be returned to the triggering button for accessibility reasons.

#### positionMenu()

Positions the Popover dialog according to the placement and alignment options. If `enableReflow` is `true`, the position will call `calcReflowPosition` to find the most suitable position according to the available space within the window and the original placement and alignment provided.

#### remove()

Removes all event listeners, observers, and references to the Popover instance. Fires the `onRemove` event.

#### show()

Shows the Popover dialog and fires the `onShow` event.

#### toggle()

If the Popover is shown, this function hides it and fires the `onHide` event. If the Popover is hidden, this function shows it and fires the `onShow` event.

#### update()

Updates the Popover's configuration and repositions the dialog if it's currently shown. It is recommended to call `update()` if DOM within the dialog has changed, as this method will also refresh the `tabbableElements` array which is necessary for the keyboard trap to function as expected. This method fires the `onUpdate` event.

| Parameters                | Type      | Default   | Description                                                                       |
|---------------------------|-----------|-----------|-----------------------------------------------------------------------------------|
| _Options_                 | `Object`  | `{}`      | An object containing configuration options for the Popover                        |
| _Options_.`placement`     | `String`  | `null`    | The new placement for the dialog                                                  |
| _Options_.`alignment`     | `String`  | `null`    | The new alignment for the dialog                                                  |
| _Options_.`offset`        | `Number`  | `null`    | The new dialog offset in pixels                                                   |
| _Options_.`enableReflow`  | `Boolean` | `null`    | Whether the dialog should auto-adjust positioning based on window real estate     |
| _Options_.`enableFade`    | `Boolean` | `null`    | Whether the dialog should animate in and out with a fade effect                   |


### Instance properties

These are the properties accessible on an instance of Popover:

| Name              | Type        | Description                                   |
|-------------------|-------------|-----------------------------------------------|
| `alignment`       | `String`    | Which edge of the dialog and trigger to align |
| `arrow`           | `Node`      | The indicator arrow element                   |
| `boundingRect`    | `Object`    | An Object containing `DOMRect` objects defining the bounding rectangles for the trigger (`el`), dialog (`menu`), and the trigger's parent element (`parent`) |
| `el`              | `Node`      | The triggering button element                 |
| `enableFade`      | `Boolean`   | Whether transitions animations should be done when hiding and showing the Popover dialog |
| `enableReflow`    | `Boolean`   | Whether to fall back to alternate positioning of the dialog when the viewport is too small |
| `events`          | `Array`     | A list of the event listeners added by this instance |
| `menu`            | `Node`      | The Popover dialog                            |
| `offset`          | `Number`    | The space to leave between the dialog and the trigger when positioning the dialog, in pixels |
| `overflowOffset`  | `Number`    | The number of pixels the menu must be offset to prevent horizontal scrolling of the window for menus positioned `top` or `bottom` |
| `parent`          | `Node`      | The parent element of the triggering button   |
| `placement`       | `String`    | Which side of the triggering button to place the Popover dialog on |
| `reflowPosition`  | `Object`    | An Object storing the most recent result of a reflow calculation, a `placement` and `alignment` |
| `shown`           | `Boolean`   | Whether the Popover dialog is currently shown |
| `tabbableElements`| `Array`     | A list of tab focusable elements within the dialog |
| `translateX`      | `Number`    | The calculated `x` value of the inline CSS style `transform: translate(x, y);` used to visually place the menu |
| `translateY`      | `Number`    | The calculated `y` value of the inline CSS style `transform: translate(x, y);` used to visually place the menu |
