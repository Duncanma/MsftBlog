A Modal is dialog that, when launched, pops up over the page, takes the user's focus, and obscures the rest of the page content until it is closed.

For reference, the main markup of the Modal consists of a "Modal document" which has the content of the Modal and is the actual box that visual users see, nested inside the "Modal dialog" wrapper which initially grabs and traps the focus of the user, and indicates to assistive technology that a dialog has been launched:

```html
<div data-mount="modal" tabindex="-1" role="dialog" aria-modal="true">
  <div class="modal-dialog" role="document">
    Modal content
  </div>
</div>
```

## Responsiveness

The Modal document will fill the entire width of the page (apart from some gutters on either side) up to a certain maximum width. The maximum width can be configured with modifier classes used alongside the `modal-dialog` class. For example, using the modifier class `modal-lg`:

```html
<div class="modal-dialog modal-lg" role="document">
  ...
</div>
```

One of four variants can be selected, each with different behaviors:

| Modifier class    | Variant           | Gutters below 540px | Gutters above 1084px  | Maximum width |
| ----------------- | ----------------- | ------------------- | --------------------- | ------------- |
| `modal-sm`        | Small             | `12px`              | _(Not applicable)_    | `300px`       |
| _(none)_          | Default           | `12px`              | _(Not applicable)_    | `640px`       |
| `modal-lg`        | Large             | `12px`              | _(Not applicable)_    | `800px`       |
| `modal-xl`        | Extra Large       | `12px`              | `5%` (of the `body`)  | `1600px`      |

In the table above, "gutters" refers to padding added on the left and right to separate the dialog from the edges of the viewport. Note that if for some reason the Modal document overflows the viewport vertically, causing a scrollbar to appear, the Modal JavaScript class will attempt to compensate by adding additional padding to the Modal document's parent element to keep the Modal centered. For example:

```html
<div class="modal fade show" role="dialog">
  <div class="modal-dialog" role="document">
    ...
  </div>
</div>
```

However, in cases where the Modal document is expected to overflow, the "scrollable" variant, implemented by the `modal-dialog-scrollable` modifier class, is recommended.

## Style

Many of the default styles of the Modal can be fine tuned via modifier classes and utility classes as outlined below, but some style and structure aspects are more strictly required.

The backdrop element below visually obscures the content of the page to give the Modal document a pop-up effect. By default, it has background color of `#000` with an opacity of `.08`. Since the backdrop element is created and appended to the `<body>` by the Modal class whenever the Modal dialog is shown and destroyed when the dialog is hidden, any customizations would have to be made via JavaScript. It can be accessed at _modalInstance_.`backdrop`

```html
<div class="modal-backdrop"></div>
```

The content within the Modal document is organized into "header," "body," and optional "footer" `<div>`s, stacked vertically. By default, the height of Modal document only expands to fit its content. However, if customized to have a particular height, the body `<div>` is styled via flexbox to expand to fill the empty space, so the header will stay at the top and the footer will stay at the bottom.

```html
<div class="modal fade show" role="dialog" aria-labelledby="exampleModalLabel"><!-- Modal dialog -->
  <div class="modal-dialog" role="document"><!-- Modal document -->
    <div class="modal-content"><!-- Modal content -->
      <div class="modal-header"><!-- Header -->
        <h2 class="modal-title h6" id="exampleModalLabel">Modal Title</h2><!-- Title (optional) -->
        <button type="button" class="close" data-dismiss="modal" aria-label="Close dialog window" title="Close"></button><!-- Close button -->
      </div>
      <div class="modal-body"><!-- Body -->
        Modal body content
      </div>
      <div class="modal-footer"><!-- Footer (optional) -->
        Modal footer content
      </div>
    </div>
  </div>
</div>
```

**Accessibility note:** The "header" `<div>` must be present and must include the "Close button" so that keyboard users can exit the Modal document. The heading for the Modal should go here as well, if there is one, so that it is the first thing read by screen readers; if placed in the "body" `<div>`, the "Close" button will be read first. The heading should not be `<h1>` and should follow the hierarchy of the page.

**Accessibility note:** When the Modal dialog is shown, screen readers will attempt orient the user by reading it. It is best to provide an accessible name for the dialog so that screen reader users can discern the purpose of the dialog. This can be done either by using the `aria-labelledby` property (set to match the `id` of the heading) as in the example above, or, in cases where there is no heading to point to, a descriptive `aria-label` can be used.


Within the Modal document, several namespaced classes implement the default style of the MWF Modal. They are not configurable, but are included here for reference.

| Element                   | Class                     | Description                                                                                                 |
| ------------------------- | ------------------------- | ----------------------------------------------------------------------------------------------------------- |
| Modal document            | `modal-dialog`            | Vertically and horizontally centers Modal document and implements slide-in/-out animation                   |
| Modal dialog              | `modal`                   | Stacks the rest of the Modal elements in front of rest of the page                                          |
| Modal dialog              | `fade`                    | Not namespaced, but implements show/hide animations (**strictly required for function**)                    |
| Modal content             | `modal-content`           | Sets background color, border, spacing for the Modal document overall, and starts flex context              |
| "Header" `<div>`          | `modal-header`            | Sets spacing and flex options, and adjusts "Close" button styles                                            |
| Heading                   | `modal-title`             | Adjusts spacing and line height to better align element with the "Close" button (when used within "header") |
| "Body"  `<div>`           | `modal-body`              | Sets flex properties so this element expands vertically to fill space                                       |
| "Footer" `<div>`          | `modal-footer`            | Vertically centers and right aligns children, adds `0.5em` of space between children; intended for buttons  |
| Modal backdrop            | `modal-backdrop`          | Generated by Modal JavaScript class to set color and size styles for the backdrop                           |
| `<body>` element          | `modal-open`              | Set by Modal JavaScript class to hide any overflow, thereby prevent scrolling of the page in the background |

### Modifier classes

These namespaced classes can be added to the Modal document element alongside the `modal-dialog` class to set key styles. The size classes (`modal-sm`, `modal-lg`, and `modal-xl`) are discussed in more detail in the [Responsiveness](#responsiveness) section above.

| Class                     | Description                                                                                 |
| ------------------------- | ------------------------------------------------------------------------------------------- |
| `modal-sm`                | Sets the maximum width of the document to `300px`                                           |
| `modal-lg`                | Sets the maximum width of the document to `800px`                                           |
| `modal-xl`                | Sets the maximum width of the document to `1600px`                                          |
| `modal-dialog-scrollable` | Dialog will not overflow the viewport vertically; instead, the "body" `<div>` is scrollable |

### Utility classes

Although generally style utilities may be combined with the Modal to customize it, the utilities used in the example code are summarized in this table as a reference:

| Utility            | Example                         | Description                                       | Documentation                                                                                                                        |
| ------------------ | ------------------------------- | ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| Text align         | `text-center`                   | Sets text alignment                               | [Text align utility docs](https://moray-prod.azurewebsites.net/components/detail/utilities-text--alignment.html)                     |
| Margin             | `mr-2`                          | Sets margin                                       | [Margin utility docs](https://moray-prod.azurewebsites.net/components/detail/utilities-spacing--margin.html)                         |

### Supporting components

This component makes use of supporting components that provide important auxiliary functionality. The most important supporting component is the [Button](https://moray-prod.azurewebsites.net/components/detail/button--default.html) component, used in the "footer" `<div>`, as well as the special [Close](https://moray-prod.azurewebsites.net/components/detail/close.html) component, which is a special type of button.

One other supporting component is the [Heading](https://moray-prod.azurewebsites.net/components/detail/headings--heading-6.html) component, which allows for the `<h2>` headings of the Modal appear as a more proportional size.

## Behavior

The Modal is a type of dialog. When shown, it interrupts the user and blocks the user from accessing the rest of the page until the Modal is closed.

### Showing the dialog

After an instance of the Modal class is initialized, the Modal dialog can be shown. Whenever the Modal dialog is shown a type of launch sequence is initiated, where the instance:

- Dispatches a custom event indicating that the Modal has started to be shown
- Prevents scrolling of the main page and temporarily adjusts styles and markup to make the Modal display properly
- Restricts keyboard focus to the Modal dialog
- Adds a keyboard listener so that the `ESC` key will hide the Modal
- Adds event handlers so that any click outside the Modal document (but still on the page) hides the Modal dialog
- Adds event handlers to any element with `data-dismiss="modal"` so that when they are clicked/activated, the Modal dialog is hidden
  - This will commonly be the required [Close](https://moray-prod.azurewebsites.net/components/detail/close.html) component, or a "Cancel" button within the Modal document
- Creates the backdrop element and sets off the transition animation
  - Note that the `fade` class is strictly required to be present for the Modal to function at all, the transition animation can only be altered, not removed entirely
- Once the transition is finished, makes the Modal document visible
- Dispatches a custom event indicating that the Modal has been shown
- Focuses the Modal dialog
  - For this part to work properly, the Modal dialog must have `tabindex="-1"`. If using a scrollable Modal with the `modal-dialog-scrollable` class, the "header" with the `modal-header` class should have `tabindex="-1"` as well

### Triggering element

By default, the Modal is set up to be launched by a single button. When initializing the Modal instance will search the `document` for an element with `data-target="#{modal-dialog-id}"` and attach a event listeners so it will launch the Modal. This triggering element is also focused when the Modal is hidden. Note that multiple triggering elements are not supported.

The Modal can also be set up so that it launches right after it initializes, either by setting the option in the constructor:

```js
myModal = new mwf.Modal({
  el: document.querySelector('#myModalId'),
  displayOnInit: true
});
```

...or as a data attribute on the Modal dialog, when using the auto-initialization script.

```html
<div data-mount="modal" role="dialog" data-display-on-init="true" aria-modal="true">
```

Also, the Modal can be launched with a call to the `.show()` function of the instance. Keep in mind though, that while an unexpected Modal dialog is disruptive for all users, it is even more disorienting for users relying on screen readers and other assistive technology. So, to ensure accessibility, the Modal should almost always be launched in response to a user action. For instances where the Modal is used to collect information from the user before they interact with the page (e.g., a language selector) it should be launched as soon as possible after the page loads.

Note that if no trigger element is present, when the Modal is hidden it will not have an element to return focus to, so keyboard and screen reader users will find themselves wherever in the document the Modal dialog element is located. So, for Modals launched at page load, the markup must be placed at the top, before any page content (e.g., the first child of the `<body>` tag).

### Backdrop

The backdrop visually obscures the page, but only partially, so visual users can rest assured that they are still on the same page. The backdrop element is created when the Modal dialog is shown, and destroyed when it is hidden. Although it appears that clicking the backdrop closes the Modal, it has no event listeners; any clicks outside the Modal document on the `<body>` cause the Modal to hide itself.

### Hiding the dialog

Whenever the Modal dialog is hidden, it undergoes a tear-down process. The Modal instance:

- Dispatches a custom event indicating that the Modal has started to be hidden
- Re-enables interaction with the rest of the page and removes temporary styles
- Returns keyboard function to normal
- Removes event listeners for the elements that hide the Modal
- Destroys the backdrop element and sets off the transition animation
- Once the visual transition is finished, it hides the Modal document from other users by setting the style `display: none`
- Dispatches a custom event indicating that the Modal has been hidden
- Focus the triggering element (if present)

### Circular focus

The Modal class also manages focus for keyboard and assistive technology users. When it's initialized, it creates a list of "tabbable" elements inside the Modal dialog. When the Modal dialog is shown, it listens for Tab key presses and makes sure that it only tabs to those tabbable elements. Note that this means **any elements added after initialization will be skipped in the tab order**. Also, the Modal instance will listen for focus events on the whole document, and if the target of that focus event is not inside the Modal dialog, the Modal dialog will get focus instead. For example, if another script on the page tries to focus an element while the Modal is shown, the Modal dialog will be focused instead (via `HTMLElement.focus()`).

When the Modal is launched, the Modal dialog element itself will be focused. If using a scrollable Modal, the "header" with the `modal-header` class and `tabindex="-1"` will receive focus instead.

## JavaScript usage

By default, the Modal class is found on the `mwf` object at `window.mwf.Modal`

### Initialization

Adding the attribute `data-mount="modal"` to the Modal dialog element will cause the auto-initialization script to create an instance of the Modal class

```html
<div data-mount="modal" tabindex="-1" role="dialog" aria-modal="true">
  <div class="modal-dialog" role="document">
    Modal content
  </div>
</div>
```

The Modal can also be initialized via JavaScript by passing in the Modal dialog element:

```js
myModal = new mwf.Modal({
  el: document.querySelector('#myModalId'),
  displayOnInit: true // optional, defaults to false
});
```

Options are passed to the constructor as an object with the following properties:

| Name               | Type       | Required | Description                                                              |
| ------------------ | ---------- | -------- | ------------------------------------------------------------------------ |
| `el`               | `Node`     | yes      | The Modal dialog element                                                 |
| `displayOnInit`    | `Boolean`  | no       | Whether to show the Modal as soon as it's initialized                    |

### Events

This table summarizes custom events that can be fired by a Modal instance. Events that don't bubble must be listened for on the event target.

| Event name | Event target    | Bubbles | Description                                                                                                              |
| ---------- | --------------- | ------- | ------------------------------------------------------------------------------------------------------------------------ |
| `onHide`   | _instance_.`el` | No      | Dispatches when the Modal starts its fade-out animation                                                                  |
| `onHidden` | _instance_.`el` | No      | Dispatches as the Modal finishes its fade-out animation                                                                  |
| `onShow`   | _instance_.`el` | No      | Dispatches when the Modal starts its fade-in animation                                                                   |
| `onShown`  | _instance_.`el` | No      | Dispatches as the Modal finishes its fade-in animation                                                                   |
| `onRemove` | _instance_.`el` | Yes     | Dispatches when the `.remove()` method is called on a Modal instance, removing event listeners and deleting the instance |

### Static methods

#### getInstances()

Returns a list of all instances of Modal.

| Returns | Description                                                                                                                                                 |
| ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Array   | An array of all current instances (note that deleting the associated DOM nodes will not remove an instance of Modal; `remove()` must be called explicitly)  |

### Instance methods

#### handleUpdate()

This function checks if the Modal document is overflowing the viewport and adjusts styles accordingly. It's automatically triggered on `resize` events, but can be called as an instance method in case the content of the Modal document changes.

#### hide(event)

Hides the Modal dialog. If an event is passed in as a parameter, it will be canceled with `event.preventDefault()`

Options:
| Params   | Type    | Required | Default | Description                                                                 |
| -------- | ------- | -------- | ------- | --------------------------------------------------------------------------- |
| `event`  | `Event` | no       | `null`  | Any event, gets canceled via `preventDefault()`                             |

#### remove()

Removes all event listeners and removes the instance. Will dispatch the custom event `onRemove` to the Modal dialog element.

#### show()

Shows the Modal dialog.

#### toggle(event)

If the Modal is hidden, it shows it. If the Modal is shown, it hides it. If an event is passed in as a parameter, the target of the event will become the new trigger element for the Modal, meaning that when the Modal is closed, focus will be returned to that element. It will not pass this event parameter down to a call of `.hide()`, so the event will not be canceled.

Options:
| Params   | Type    | Required | Default | Description                                                                 |
| -------- | ------- | -------- | ------- | --------------------------------------------------------------------------- |
| `event`  | `Event` | no       | `null`  | Any event, `event.target` gets set as _instance_.`trigger`                  |

### Instance properties

Besides the functions and events documented above, these are the properties exposed on an instance of Modal. These are generally intended to be read-only, altering them directly may have unpredictable side-effects.

| Name                      | Type          | Description                                                                                                               |
| ------------------------- | ------------- | ------------------------------------------------------------------------------------------------------------------------- |
| `backdrop`                | `Node`        | Backdrop element, should only exist when Modal is shown                                                                   |
| `button`                  | `Node`        | Button found during initialization with `data-target="#instanceId"` that gets event listeners to toggle the Modal         |
| `dialog`                  | `Node`        | The Modal document with the class `modal-dialog` and the role `document`                                                  |
| `el`                      | `Node`        | The Modal dialog with the role `dialog`                                                                                   |
| `firstTabbableElement`    | `Node`        | The first element in the Modal dialog that can be tabbed to; static and detected during initialization                    |
| `ignoreBackdropClick`     | `Boolean`     | Deprecated; altering this property will not cause clicks on the backdrop to be ignored                                    |
| `isBodyOverflowing`       | `Boolean`     | Whether the `<body>` element overflows the viewport vertically                                                            |
| `isShown`                 | `Boolean`     | Whether the Modal dialog is currently fully shown                                                                         |
| `isTransitioning`         | `Boolean`     | Whether the Modal dialog is currently transitioning between shown and hidden, in either direction                         |
| `lastTabbableElement`     | `Node`        | The last element in the Modal dialog that can be tabbed to; static and detected during initialization                     |
| `scrollbarWidth`          | `Number`      | The width of the browser scrollbar, used to center the Modal document properly                                            |
| `tabbableElements`        | `Array`       | An array of elements in the Modal dialog that can be tabbed to; static and detected during initialization                 |
| `trigger`                 | `Node`        | The element that is focused when the Modal is hidden; typically the same as _instance_.`button`                           |